#!/usr/bin/env node
"use strict";

/**
 * Module dependencies
 */

var debug = require('debug')('express-example');
var app = require('../app');
var models = require("../models");
var forceSSL = require('express-force-ssl');
var fs = require('fs');
var http = require('http');
var https = require('https');
var express = require('express');
var cluster = require('cluster');
var cpus = require('os').cpus().length;

var ssl_options = {
  key: fs.readFileSync('./bin/comet.key'),
  cert: fs.readFileSync('./bin/comet.crt')
};

/* var app = express(); */

app.set('port', process.env.PORT || 3000);

app.set('forceSSLOptions', {
  enable301Redirects: true,
  trustXFPHeader: false,
  httpsPort: 4000,
  sslRequiredMessage: 'SSL Required.'
});

models.sequelize.sync().then(function () {

  console.log('cpus are: ', cpus);

  if (cluster.isMaster) {
	// Fork the workers
	for (var i = 0; i < cpus; i ++) {
		cluster.fork();
	}
} else {
  var server = https.createServer(ssl_options, app);

  server.listen(app.get('port'), function() {
    console.log('Express server worker ' + cluster.worker.id + 'listening on port ' + server.address().port);
  });
  require('../lib/socket').listen(server);

  var server_http = http.createServer(app);
  server_http.listen(4001, function() {
        console.log('Express server worker ' + cluster.worker.id + 'listening on port ' + server_http.address().port);
  });
  require('../lib/socket').listen(server_http);
}
});
